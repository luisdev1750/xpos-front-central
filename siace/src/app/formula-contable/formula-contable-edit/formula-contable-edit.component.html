<h2>Detalle del f√≥rmula contable</h2>
<form
  *ngIf="formulaContable"
  #editForm="ngForm"
  (ngSubmit)="save()"
  autocomplete="off"
>
  <div class="row">
    <div class="col-md-3">
      <mat-form-field>
        <mat-label>Sucursal</mat-label>
        <mat-select
          [value]="formulaContable.focSucId"
          (selectionChange)="OnSucursalChange($event)"
          [disabled]="sucursalBloqueada || isEditing"
          required
        >
          <mat-option [value]="null">Sin sucursal</mat-option>
          <mat-option
            *ngFor="let sucursal of listSucursales"
            [value]="sucursal.sucId"
          >
            {{ sucursal.sucNombre }}
          </mat-option>
        </mat-select>
        <mat-hint *ngIf="sucursalBloqueada" style="color: #ff9800">
          üîí Bloqueada por f√≥rmulas compuestas
        </mat-hint>
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field>
        <mat-label for="focFormula">F√≥rmula</mat-label>
        <input
          matInput
          [(ngModel)]="formulaContable.focFormula"
          id="focFormula"
          name="focFormula"
          placeholder="F√≥rmula (ej: VBC + DDC - PDE)"
          required
          readonly
        />
        <mat-error *ngIf="formulaContable.focFormula == ''"
          >F√≥rmula es requerido</mat-error
        >
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field>
        <mat-label for="focClave">Clave</mat-label>
        <input
          matInput
          [(ngModel)]="formulaContable.focClave"
          id="focClave"
          name="focClave"
          placeholder="C√≥digo"
          required
        />
        <mat-error *ngIf="formulaContable.focClave == ''"
          >C√≥digo es requerido</mat-error
        >
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field>
        <mat-label for="focNombre">Nombre</mat-label>
        <input
          matInput
          [(ngModel)]="formulaContable.focNombre"
          id="focNombre"
          name="focNombre"
          placeholder="Nombre"
          required
        />
        <mat-error *ngIf="formulaContable.focNombre == ''"
          >Nombre es requerido</mat-error
        >
      </mat-form-field>
    </div>

    <div class="col-md-3">
      <mat-form-field>
        <mat-label>Activo</mat-label>
        <mat-select
          [(ngModel)]="formulaContable.focEstatusEdicion"
          id="focEstatusEdicion"
          name="focEstatusEdicion"
        >
          <mat-option [value]="true">S√≠</mat-option>
          <mat-option [value]="false">No</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Constructor de f√≥rmulas -->
  <div class="row formula-builder">
    <div class="col-md-12">
      <mat-card>
        <mat-card-header>
          <h6>Constructor de F√≥rmulas</h6>
        </mat-card-header>
        <mat-card-content>
          <div class="box-formulas">
            <!-- Variables simples disponibles -->
            <div class="variables-section">
              <h6>
                Variables Contables Simples
                <span class="info-badge badge-variable">{{
                  variablesSimples.length
                }}</span>
              </h6>
              <p style="color: #666; font-size: 13px; margin-top: 5px">
                Estas son f√≥rmulas elementales
              </p>
              <div class="chip-container">
                <mat-chip-set>
                  <mat-chip
                    *ngFor="let variable of variablesSimples"
                    [disabled]="!variable.vacActivo"
                    (click)="insertarVariable(variable)"
                    [matTooltip]="variable.vacNombre"
                    class="variable-chip"
                  >
                    {{ variable.vacClave }}
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>

            <!-- F√≥rmulas compuestas -->
            <div
              class="variables-section"
              *ngIf="formulasCompuestas.length > 0"
            >
              <h6>
                F√≥rmulas Compuestas üìê
                <span class="info-badge badge-formula">{{
                  formulasCompuestas.length
                }}</span>
              </h6>
              <p style="color: #666; font-size: 13px; margin-top: 5px">
                Estas son f√≥rmulas que ya han sido creadas y pueden ser
                reutilizadas
              </p>
              <div class="chip-container">
                <mat-chip-set>
                  <mat-chip
                    *ngFor="let formula of formulasCompuestas"
                    [disabled]="!formula.vacActivo"
                    (click)="insertarVariable(formula)"
                    [matTooltip]="
                      formula.vacNombre + ' ' + formula.vacFormulaDesc
                    "
                    class="variable-chip formula-chip"
                  >
                    {{ formula.vacClave }}
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>
          </div>

          <div class="box-buttons section-divider">
            <!-- Operadores -->
            <div class="operators-section">
              <h6>Operadores:</h6>
              <div class="button-group">
                <button
                  type="button"
                  mat-raised-button
                  (click)="insertarOperador('+')"
                  class="operator-btn"
                >
                  +
                </button>
                <button
                  type="button"
                  mat-raised-button
                  (click)="insertarOperador('-')"
                  class="operator-btn"
                >
                  -
                </button>
                <button
                  type="button"
                  mat-raised-button
                  (click)="insertarOperador('*')"
                  class="operator-btn"
                >
                  √ó
                </button>
                <button
                  type="button"
                  mat-raised-button
                  (click)="insertarOperador('/')"
                  class="operator-btn"
                >
                  √∑
                </button>
                <button
                  type="button"
                  mat-raised-button
                  (click)="insertarOperador('^')"
                  class="operator-btn"
                >
                  ^
                </button>
                <button
                  type="button"
                  mat-raised-button
                  (click)="insertarOperador('(')"
                  class="operator-btn"
                >
                  (
                </button>
                <button
                  type="button"
                  mat-raised-button
                  (click)="insertarOperador(')')"
                  class="operator-btn"
                >
                  )
                </button>
              </div>
            </div>

            <!-- Secci√≥n de n√∫meros -->
            <div class="numbers-section">
              <h6>N√∫meros:</h6>
              <div class="number-input-container">
                <mat-form-field class="number-input">
                  <mat-label>Ingrese un n√∫mero</mat-label>
                  <input
                    matInput
                    type="number"
                    [(ngModel)]="numeroTemporal"
                    name="numeroTemporal"
                    placeholder="Ej: 100, 2.5, -10"
                    (keyup.enter)="insertarNumero()"
                  />
                </mat-form-field>
                <button
                  type="button"
                  mat-raised-button
                  color="primary"
                  (click)="insertarNumero()"
                  [disabled]="!numeroTemporal && numeroTemporal !== 0"
                  class="insert-number-btn"
                >
                  Insertar N√∫mero
                </button>
              </div>
            </div>
          </div>

          <!-- Vista previa de la f√≥rmula -->
          <div class="formula-preview section-divider">
            <h6>
              Vista Previa:
              <span
                *ngIf="!validarFormula() && formulaPreview.length > 0"
                style="color: #f44336; font-size: 12px; margin-left: 10px"
              >
                ‚ö†Ô∏è F√≥rmula inv√°lida
              </span>
              <span
                *ngIf="validarFormula() && formulaPreview.length > 0"
                style="color: #4caf50; font-size: 12px; margin-left: 10px"
              >
                ‚úì F√≥rmula v√°lida
              </span>
            </h6>
            <div class="preview-box">
              <span *ngIf="formulaPreview.length === 0" class="placeholder">
                Selecciona variables, f√≥rmulas, n√∫meros y operadores para
                construir tu f√≥rmula
              </span>
              <span
                *ngFor="let token of formulaPreview; let i = index"
                class="formula-token"
                [class.variable]="isVariable(token)"
                [class.variable-formula]="isFormulaCompuesta(token)"
                [class.operator]="isOperator(token)"
                [class.number]="isNumber(token)"
                [matTooltip]="getVariableNombre(token)"
              >
                {{ token }}
              </span>
            </div>
          </div>

          <!-- Acciones del constructor -->
          <div class="builder-actions">
            <button
              type="button"
              mat-raised-button
              color="warn"
              (click)="limpiarFormula()"
            >
              üóëÔ∏è Limpiar F√≥rmula
            </button>
            <button
              type="button"
              mat-raised-button
              (click)="eliminarUltimo()"
              [disabled]="formulaPreview.length === 0"
            >
              ‚Ü∂ Deshacer √öltimo
            </button>
            <button
              type="submit"
              mat-raised-button
              color="primary"
              [disabled]="!puedeGuardar()"
            >
              üíæ Guardar F√≥rmula Contable
            </button>

            <button mat-button mat-dialog-close>Cancelar</button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <div class="button-row text-center" role="group"></div>
</form>
