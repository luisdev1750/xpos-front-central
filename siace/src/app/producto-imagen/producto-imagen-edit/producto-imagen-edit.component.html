<h2>{{ isEditMode ? "Editar" : "Agregar" }} Imágenes de Producto</h2>

<form *ngIf="productoImagen" #editForm="ngForm" (ngSubmit)="save()" autocomplete="off">
  <div class="row">
    <!-- BUSCADOR DE PRODUCTO (Solo en modo crear) -->
    <div class="col-md-12" *ngIf="!isEditMode">
      <mat-form-field>
        <mat-label>Producto</mat-label>
        <input
          type="text"
          matInput
          [formControl]="productoControl"
          [matAutocomplete]="autoProducto"
          placeholder="Buscar por nombre, descripción, SKU o ID..."
          [readonly]="isEditMode"
        />
        <button
          *ngIf="productoControl.value && !isEditMode"
          matSuffix
          mat-icon-button
          aria-label="Limpiar"
          type="button"
          (click)="onProductoClear()"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete
          #autoProducto="matAutocomplete"
          [displayWith]="displayProductoFn"
          (optionSelected)="onProductoSelected($event.option.value)"
        >
          <mat-option
            *ngFor="let producto of filteredProductos | async"
            [value]="producto"
          >
            <span>
              <strong>{{ producto.proSku }}</strong> - {{ producto.proNombre }}
            </span>
            <br />
            <small style="color: #666" *ngIf="producto.proDescripcion">
              {{ producto.proDescripcion }}
            </small>
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="!productoImagen.proId && !isEditMode">
          Producto es requerido
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Producto seleccionado (en modo edición) -->
    <div class="col-md-12" *ngIf="isEditMode">
      <mat-form-field>
        <mat-label>Producto</mat-label>
        <input
          matInput
          [(ngModel)]="productoImagen.proNombre"
          id="proNombre"
          name="proNombre"
          readonly
          required
        />
        <mat-hint>SKU: {{ productoImagen.proSku }}</mat-hint>
      </mat-form-field>
    </div>
  </div>

  <!-- SECCIÓN AGREGAR IMAGEN -->
  <div class="row" style="margin-top: 24px; margin-bottom: 16px">
    <div class="col-md-12">
      <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 500; color: #666;">
        Agregar Imagen al Producto
      </h3>
    </div>

    <div class="col-md-6">
      <mat-form-field>
        <mat-label>Tipo de imagen</mat-label>
        <mat-select
          [(ngModel)]="tipoImagenSeleccionado"
          name="tipoImagenSeleccionado"
          [disabled]="!productoImagen.proId || tiposDisponibles.length === 0"
        >
          <mat-option
            *ngFor="let tipo of tiposDisponibles"
            [value]="tipo.timId"
          >
            {{ tipo.timNombre }}
          </mat-option>
        </mat-select>
        <mat-hint *ngIf="!productoImagen.proId" style="color: #f44336">
          Primero seleccione un producto
        </mat-hint>
        <mat-hint *ngIf="productoImagen.proId && tiposDisponibles.length === 0" style="color: #4caf50">
          ✓ Todos los tipos agregados (5/5)
        </mat-hint>
      </mat-form-field>
    </div>

    <div class="col-md-6">
      <div class="file-input-wrapper">
        <input
          type="file"
          (change)="onFileSelected($event)"
          accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
          #fileInput
          style="display: none"
        />
        <button
          type="button"
          mat-raised-button
          color="accent"
          (click)="fileInput.click()"
          [disabled]="!productoImagen.proId"
          style="width: 100%;"
        >
          <mat-icon>cloud_upload</mat-icon>
          {{ archivoTemporal ? 'Cambiar archivo' : 'Seleccionar archivo' }}
        </button>
        
        <div *ngIf="archivoTemporal" style="margin-top: 8px; color: #666; font-size: 14px;">
          <mat-icon style="vertical-align: middle; font-size: 18px">attachment</mat-icon>
          {{ archivoTemporal.name }} ({{ (archivoTemporal.size / 1024).toFixed(2) }} KB)
        </div>
      </div>
    </div>

    <div class="col-md-12" style="margin-top: 16px; display: flex; gap: 10px;">
      <button
        type="button"
        mat-raised-button
        color="primary"
        (click)="agregarImagenALista()"
        [disabled]="!tipoImagenSeleccionado || !archivoTemporal || !productoImagen.proId"
        style="flex: 1;"
      >
        <mat-icon>add</mat-icon>
        Agregar a la lista
      </button>
      
      <button
        type="button"
        mat-button
        color="warn"
        (click)="limpiarFormularioTemporal()"
        [disabled]="!tipoImagenSeleccionado && !archivoTemporal"
      >
        <mat-icon>clear</mat-icon>
        Limpiar
      </button>
    </div>

    <div class="col-md-12" style="margin-top: 8px;">
      <mat-hint style="font-size: 14px; color: #666; display: flex; align-items: center">
        <mat-icon style="vertical-align: middle; font-size: 18px; margin-right: 8px">info</mat-icon>
        <span *ngIf="productoImagen.proId">
          Imágenes agregadas: {{ listaImagenes.length }}/5
        </span>
        <span *ngIf="!productoImagen.proId" style="color: #f44336">
          Seleccione un producto para agregar imágenes
        </span>
      </mat-hint>
    </div>
  </div>

  <!-- TABLA DE IMÁGENES -->
  <div *ngIf="listaImagenes && listaImagenes.length > 0" style="margin-top: 16px">
    <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 500; color: #666;">
      Imágenes del Producto ({{ listaImagenes.length }}/5)
    </h3>
    <table mat-table [dataSource]="listaImagenes" class="mat-elevation-z2">
      <!-- Columna Preview -->
      <ng-container matColumnDef="preview">
        <mat-header-cell *matHeaderCellDef style="flex: 0 0 100px;"> Vista Previa </mat-header-cell>
        <mat-cell *matCellDef="let item" style="flex: 0 0 100px;">
          <img 
            [src]="item.preview" 
            alt="Preview" 
            style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; cursor: pointer;"
            (click)="abrirImagenEnNuevaPestana(item.preview)"
            matTooltip="Click para ver en tamaño completo"
          />
        </mat-cell>
      </ng-container>

      <!-- Columna Tipo -->
      <ng-container matColumnDef="tipoNombre">
        <mat-header-cell *matHeaderCellDef> Tipo de Imagen </mat-header-cell>
        <mat-cell *matCellDef="let item">
          <mat-chip 
            [style.background-color]="getTipoColor(item.tipoNombre)"
            style="color: white;">
            {{ item.tipoNombre }}
          </mat-chip>
        </mat-cell>
      </ng-container>

      <!-- Columna Nombre Archivo -->
      <ng-container matColumnDef="nombreArchivo">
        <mat-header-cell *matHeaderCellDef> Nombre Archivo </mat-header-cell>
        <mat-cell *matCellDef="let item">
          {{ item.nombreArchivo || (item.archivo ? item.archivo.name : 'N/A') }}
        </mat-cell>
      </ng-container>

      <!-- Columna Estado -->
      <ng-container matColumnDef="estado">
        <mat-header-cell *matHeaderCellDef style="flex: 0 0 100px;"> Estado </mat-header-cell>
        <mat-cell *matCellDef="let item" style="flex: 0 0 100px;">
          <mat-chip 
            [style.background-color]="item.isNew ? '#4caf50' : '#2196f3'"
            style="color: white; font-size: 11px;">
            {{ item.isNew ? 'Nueva' : 'Existente' }}
          </mat-chip>
        </mat-cell>
      </ng-container>

      <!-- Columna Acciones -->
      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef style="flex: 0 0 80px;"> Acciones </mat-header-cell>
        <mat-cell *matCellDef="let item" style="flex: 0 0 80px;">
          <button
            (click)="eliminarImagenDeLista(item)"
            mat-icon-button
            color="warn"
            matTooltip="Eliminar de la lista"
            type="button"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumnsImagenes"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumnsImagenes"></mat-row>
    </table>
  </div>

  <!-- Mensaje cuando no hay imágenes -->
  <div
    *ngIf="!listaImagenes || listaImagenes.length === 0"
    style="margin-top: 16px; padding: 24px; text-align: center; background-color: #f5f5f5; border-radius: 4px;"
  >
    <mat-icon style="font-size: 48px; height: 48px; width: 48px; color: #999">
      add_photo_alternate
    </mat-icon>
    <p style="margin-top: 16px; color: #666">
      No hay imágenes agregadas. Seleccione tipo de imagen y archivo para agregar.
    </p>
  </div>

  <!-- Botones de acción -->
  <div class="button-row text-center" role="group" style="margin-top: 24px">
    <button
      type="submit"
      mat-raised-button
      color="primary"
      [disabled]="!editForm.form.valid || listaImagenes.length === 0 || !productoImagen.proId"
    >
      <mat-icon>save</mat-icon>
      {{ isEditMode ? 'Actualizar' : 'Guardar' }}
    </button>
    <button type="button" mat-button (click)="cancel()">
      <mat-icon>cancel</mat-icon>
      Cancelar
    </button>
  </div>
</form>